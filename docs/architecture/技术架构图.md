# 趣印星球 - 技术架构

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户终端                              │
│                     微信小程序                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                  │
│  │  专区页  │  │ 婚纱照  │  │  订单页  │                   │
│  └──────────┘  └──────────┘  └──────────┘                  │
└─────────────────────────────────────────────────────────────┘
                          │
                          │ 云函数调用
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                   微信云开发平台                              │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │              云函数层 (55+ 个微服务)                   │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐              │  │
│  │  │ 订单服务 │ │ 打印服务 │ │ 用户服务 │              │  │
│  │  └──────────┘ └──────────┘ └──────────┘              │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐              │  │
│  │  │ 内容管理 │ │ 设备管理 │ │ 监控服务 │              │  │
│  │  └──────────┘ └──────────┘ └──────────┘              │  │
│  └───────────────────────────────────────────────────────┘  │
│                          │                                    │
│                          ↓                                    │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                   云数据库                             │  │
│  │  • orders (订单)    • devices (设备)                  │  │
│  │  • users (用户)     • banners (轮播图)                │  │
│  │  • exception_logs (异常日志)                          │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                          │
                          │ HTTP API
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                    Python AI 服务                            │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                  ComfyUI SDK                           │  │
│  │  • workflow_api_0.json (模板1)                        │  │
│  │  • workflow_api_1.json (模板2)                        │  │
│  │  • workflow_api_2.json (模板3)                        │  │
│  │  • workflow_api_3.json (模板4)                        │  │
│  │  • workflow_api_4.json (模板5)                        │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                          │
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                    外部服务                                  │
│  • 微信支付          • 美团支付                             │
│  • 打印设备 API      • 数据上报接口                         │
└─────────────────────────────────────────────────────────────┘
```

## 业务流程

### 用户打印流程

```
1. 用户扫码
   ↓
2. 绑定 deviceId → 查询设备数据 (getDeviceData)
   ↓
3. 选择模板 → 上传照片
   ↓
4. AI 生成图片 → Python API (generateImage)
   ↓
5. 异步处理队列 → processImageQueue
   ↓
6. 生成完成 → updateOrderImage
   ↓
7. 微信支付 → payNotify 回调
   ↓
8. 提交打印任务 → submitPrintJobNew
   ↓
9. 调用设备 API → 物理打印
   ↓
10. 数据上报 → /api/report/smallApp
    (包含 agentId, shopTitle 等信息)
```

## 技术选型理由

### 为什么选择微信云开发？

**优势**:
- ✅ Serverless 架构，无需运维
- ✅ 小程序原生集成
- ✅ 按需付费，成本可控
- ✅ 自动扩容，应对流量峰值

**适用场景**:
- 小程序应用
- 快速迭代
- 中小规模项目

### 为什么分离 Python AI 服务？

**理由**:
- ✅ Node.js 不擅长 AI 计算
- ✅ ComfyUI 是 Python 生态
- ✅ 独立部署，易于扩展
- ✅ GPU 资源独立管理

## 安全设计

### 用户认证
- 微信 OpenID 登录
- 云函数自动注入 `event.userInfo`

### 权限管理
- 管理员角色 (admin_users 集合)
- 普通用户角色
- `checkAdminAuth` 云函数验证

### 数据安全
- 云数据库权限规则
- 敏感字段加密
- HTTPS 传输

## 扩展性设计

### 横向扩展
- 云函数自动扩容
- 无状态设计

### 纵向扩展
- 分离计算密集型服务 (AI)
- 数据库分表策略

### 多租户支持
- 代理商隔离
- 店铺数据隔离
- deviceId 绑定机制
